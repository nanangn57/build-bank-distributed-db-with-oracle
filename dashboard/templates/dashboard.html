<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Transaction Dashboard - Oracle Sharding</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #333;
            font-size: 28px;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auto-refresh input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        
        .refresh-interval {
            margin-left: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-card.primary { border-left: 4px solid #667eea; }
        .stat-card.success { border-left: 4px solid #48bb78; }
        .stat-card.warning { border-left: 4px solid #ed8936; }
        .stat-card.info { border-left: 4px solid #4299e1; }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .region-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .region-na { background: #e6f3ff; color: #0066cc; }
        .region-eu { background: #fff4e6; color: #cc6600; }
        .region-apac { background: #e6ffe6; color: #009900; }
        
        .insert-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .success-message {
            background: #efe;
            color: #3c3;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .last-update {
            color: #666;
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ Bank Transaction Dashboard</h1>
            <div class="status-indicator" id="statusIndicator" style="display: inline-block; padding: 5px 10px; background: #48bb78; color: white; border-radius: 5px; font-size: 12px;">
                ‚úÖ Connected
            </div>
            <div class="auto-refresh">
                <label>
                    <input type="checkbox" id="autoRefresh" checked>
                    Auto Refresh
                </label>
                <select id="refreshInterval" class="refresh-interval">
                    <option value="3000">3 seconds</option>
                    <option value="5000" selected>5 seconds</option>
                    <option value="10000">10 seconds</option>
                    <option value="30000">30 seconds</option>
                </select>
                <button class="btn btn-primary" onclick="refreshDashboard()">üîÑ Refresh Now</button>
            </div>
        </div>
        
        <!-- Overall Statistics -->
        <div class="stats-grid" id="overallStats">
            <div class="stat-card primary">
                <h3>Total Users</h3>
                <div class="value" id="totalUsers">-</div>
            </div>
            <div class="stat-card success">
                <h3>Total Accounts</h3>
                <div class="value" id="totalAccounts">-</div>
            </div>
            <div class="stat-card warning">
                <h3>Total Transactions</h3>
                <div class="value" id="totalTransactions">-</div>
            </div>
            <div class="stat-card info">
                <h3>Total Balance</h3>
                <div class="value" id="totalBalance">-</div>
            </div>
        </div>
        
        <!-- Regional Statistics -->
        <div class="section">
            <h2>üìä Statistics by Region</h2>
            <div id="regionalStats">
                <div class="loading">Loading regional statistics...</div>
            </div>
        </div>
        
        <!-- Insert New Records -->
        <div class="insert-section">
            <h2>‚ûï Insert New Records</h2>
            <div class="tabs">
                <button class="tab active" onclick="showTab('user-tab')">New User</button>
                <button class="tab" onclick="showTab('account-tab')">New Account</button>
                <button class="tab" onclick="showTab('transaction-tab')">New Transaction</button>
            </div>
            
            <div id="user-tab" class="tab-content active">
                <form id="userForm" onsubmit="insertUser(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Username *</label>
                            <input type="text" name="username" required>
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" name="email" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" name="full_name">
                        </div>
                        <div class="form-group">
                            <label>Region *</label>
                            <select name="region" required>
                                <option value="NA">North America</option>
                                <option value="EU">Europe</option>
                                <option value="APAC">Asia Pacific</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="text" name="phone">
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" name="address">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Insert User</button>
                </form>
            </div>
            
            <div id="account-tab" class="tab-content">
                <form id="accountForm" onsubmit="insertAccount(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>User *</label>
                            <select name="user_id" id="userSelect" required></select>
                        </div>
                        <div class="form-group">
                            <label>Account Number *</label>
                            <input type="text" name="account_number" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Account Type *</label>
                            <select name="account_type" required>
                                <option value="CHECKING">Checking</option>
                                <option value="SAVINGS">Savings</option>
                                <option value="BUSINESS">Business</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Initial Balance</label>
                            <input type="number" name="balance" value="0" step="0.01">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Region *</label>
                            <select name="region" required>
                                <option value="NA">North America</option>
                                <option value="EU">Europe</option>
                                <option value="APAC">Asia Pacific</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Currency</label>
                            <select name="currency">
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="JPY">JPY</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">Insert Account</button>
                </form>
            </div>
            
            <div id="transaction-tab" class="tab-content">
                <form id="transactionForm" onsubmit="insertTransaction(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Transaction Type *</label>
                            <select name="transaction_type" id="txnType" required onchange="updateTransactionForm()">
                                <option value="DEPOSIT">Deposit</option>
                                <option value="WITHDRAWAL">Withdrawal</option>
                                <option value="TRANSFER">Transfer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount *</label>
                            <input type="number" name="amount" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" id="fromAccountGroup">
                            <label>From Account *</label>
                            <select name="from_account_id" id="fromAccountSelect" required>
                                <option value="">-- Select Account --</option>
                            </select>
                        </div>
                        <div class="form-group" id="toAccountGroup">
                            <label>To Account *</label>
                            <select name="to_account_id" id="toAccountSelect" required>
                                <option value="">-- Select Account --</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" name="description">
                    </div>
                    <button type="submit" class="btn btn-primary">Execute Transaction</button>
                </form>
            </div>
            
            <div id="formMessage"></div>
        </div>
        
        <!-- Users List -->
        <div class="section">
            <h2>üë• Users List</h2>
            <div id="usersList">
                <div class="loading">Loading users...</div>
            </div>
        </div>
        
        <!-- Accounts List -->
        <div class="section">
            <h2>üíº Accounts List</h2>
            <div id="accountsList">
                <div class="loading">Loading accounts...</div>
            </div>
        </div>
        
        <!-- Recent Transactions -->
        <div class="section">
            <h2>üí≥ Recent Transactions</h2>
            <div id="recentTransactions">
                <div class="loading">Loading recent transactions...</div>
            </div>
        </div>
        
        <div class="last-update" id="lastUpdate"></div>
    </div>
    
    <script>
        let refreshInterval = null;
        let refreshTime = 5000;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            loadAccounts();
            refreshDashboard();
            setupAutoRefresh();
        });
        
        function setupAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            const select = document.getElementById('refreshInterval');
            
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
            
            select.addEventListener('change', function() {
                refreshTime = parseInt(this.value);
                if (checkbox.checked) {
                    stopAutoRefresh();
                    startAutoRefresh();
                }
            });
        }
        
        function startAutoRefresh() {
            stopAutoRefresh();
            refreshInterval = setInterval(refreshDashboard, refreshTime);
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        function refreshDashboard() {
            loadOverallStats();
            loadRegionalStats();
            loadUsersList();
            loadAccountsList();
            loadRecentTransactions();
            updateLastUpdate();
        }
        
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `Last updated: ${now.toLocaleTimeString()}`;
        }
        
        async function loadOverallStats() {
            try {
                const response = await fetch('/api/stats/overall');
                const data = await response.json();
                
                document.getElementById('totalUsers').textContent = 
                    formatNumber(data.total_users || data.TOTAL_USERS || 0);
                document.getElementById('totalAccounts').textContent = 
                    formatNumber(data.total_accounts || data.TOTAL_ACCOUNTS || 0);
                document.getElementById('totalTransactions').textContent = 
                    formatNumber(data.total_transactions || data.TOTAL_TRANSACTIONS || 0);
                document.getElementById('totalBalance').textContent = 
                    formatCurrency(data.total_balance || data.TOTAL_BALANCE || 0);
            } catch (error) {
                console.error('Error loading overall stats:', error);
            }
        }
        
        async function loadRegionalStats() {
            try {
                const response = await fetch('/api/stats/regional');
                const data = await response.json();
                
                if (data.length === 0) {
                    document.getElementById('regionalStats').innerHTML = 
                        '<div class="loading">No regional data available</div>';
                    return;
                }
                
                let html = '<table><thead><tr>';
                html += '<th>Region</th><th>Users</th><th>Accounts</th><th>Transactions</th>';
                html += '<th>Total Balance</th><th>Avg Balance</th>';
                html += '</tr></thead><tbody>';
                
                data.forEach(row => {
                    html += '<tr>';
                    const region = row.region || row.REGION || 'na';
                    html += `<td><span class="region-badge region-${region.toLowerCase()}">${region}</span></td>`;
                    html += `<td>${formatNumber(row.total_users || row.TOTAL_USERS || 0)}</td>`;
                    html += `<td>${formatNumber(row.total_accounts || row.TOTAL_ACCOUNTS || 0)}</td>`;
                    html += `<td>${formatNumber(row.total_transactions || row.TOTAL_TRANSACTIONS || 0)}</td>`;
                    html += `<td>${formatCurrency(row.total_balance || row.TOTAL_BALANCE || 0)}</td>`;
                    html += `<td>${formatCurrency(row.avg_balance_per_account || row.AVG_BALANCE_PER_ACCOUNT || 0)}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                document.getElementById('regionalStats').innerHTML = html;
            } catch (error) {
                console.error('Error loading regional stats:', error);
                document.getElementById('regionalStats').innerHTML = 
                    '<div class="error">Error loading regional statistics</div>';
            }
        }
        
        async function loadUsersList() {
            try {
                const response = await fetch('/api/users/list');
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('usersList').innerHTML = 
                        '<div class="error">Error loading users: ' + data.error + '</div>';
                    return;
                }
                
                if (data.length === 0) {
                    document.getElementById('usersList').innerHTML = 
                        '<div class="loading">No users found</div>';
                    return;
                }
                
                let html = '<table><thead><tr>';
                html += '<th>ID</th><th>Username</th><th>Full Name</th><th>Email</th>';
                html += '<th>Region</th><th>Accounts</th><th>Total Balance</th><th>Created</th>';
                html += '</tr></thead><tbody>';
                
                data.forEach(user => {
                    html += '<tr>';
                    html += `<td>${user.user_id || user.USER_ID || '-'}</td>`;
                    html += `<td><strong>${user.username || user.USERNAME || '-'}</strong></td>`;
                    html += `<td>${user.full_name || user.FULL_NAME || '-'}</td>`;
                    html += `<td>${user.email || user.EMAIL || '-'}</td>`;
                    const region = user.region || user.REGION || 'na';
                    html += `<td><span class="region-badge region-${region.toLowerCase()}">${region}</span></td>`;
                    html += `<td>${user.account_count || user.ACCOUNT_COUNT || 0}</td>`;
                    html += `<td>${formatCurrency(user.total_balance || user.TOTAL_BALANCE || 0)}</td>`;
                    const createdDate = user.created_date || user.CREATED_DATE;
                    html += `<td>${createdDate ? createdDate.split(' ')[0] : '-'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                document.getElementById('usersList').innerHTML = html;
            } catch (error) {
                console.error('Error loading users list:', error);
                document.getElementById('usersList').innerHTML = 
                    '<div class="error">Error loading users list</div>';
            }
        }
        
        async function loadAccountsList() {
            try {
                const response = await fetch('/api/accounts');
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('accountsList').innerHTML = 
                        '<div class="error">Error loading accounts: ' + data.error + '</div>';
                    return;
                }
                
                if (data.length === 0) {
                    document.getElementById('accountsList').innerHTML = 
                        '<div class="loading">No accounts found</div>';
                    return;
                }
                
                let html = '<table><thead><tr>';
                html += '<th>ID</th><th>Account Number</th><th>Type</th><th>Owner</th>';
                html += '<th>Balance</th><th>Currency</th><th>Region</th><th>Status</th>';
                html += '</tr></thead><tbody>';
                
                data.forEach(account => {
                    html += '<tr>';
                    html += `<td>${account.account_id || account.ACCOUNT_ID || '-'}</td>`;
                    html += `<td><strong>${account.account_number || account.ACCOUNT_NUMBER || '-'}</strong></td>`;
                    html += `<td>${account.account_type || account.ACCOUNT_TYPE || '-'}</td>`;
                    const fullName = account.full_name || account.FULL_NAME || '';
                    const username = account.username || account.USERNAME || '';
                    html += `<td>${fullName ? fullName + ' (' + username + ')' : username || '-'}</td>`;
                    html += `<td>${formatCurrency(account.balance || account.BALANCE || 0)}</td>`;
                    html += `<td>${account.currency || account.CURRENCY || 'USD'}</td>`;
                    const region = account.region || account.REGION || 'na';
                    html += `<td><span class="region-badge region-${region.toLowerCase()}">${region}</span></td>`;
                    const status = account.status || account.STATUS || '-';
                    html += `<td><span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: ${status === 'ACTIVE' ? '#e6ffe6' : '#ffe6e6'}; color: ${status === 'ACTIVE' ? '#009900' : '#990000'};">${status}</span></td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                document.getElementById('accountsList').innerHTML = html;
            } catch (error) {
                console.error('Error loading accounts list:', error);
                document.getElementById('accountsList').innerHTML = 
                    '<div class="error">Error loading accounts list</div>';
            }
        }
        
        async function loadRecentTransactions() {
            try {
                const response = await fetch('/api/transactions/recent');
                const data = await response.json();
                
                if (data.length === 0) {
                    document.getElementById('recentTransactions').innerHTML = 
                        '<div class="loading">No recent transactions</div>';
                    return;
                }
                
                let html = '<table><thead><tr>';
                html += '<th>ID</th><th>Type</th><th>From</th><th>To</th>';
                html += '<th>Amount</th><th>Status</th><th>Date</th>';
                html += '</tr></thead><tbody>';
                
                data.forEach(txn => {
                    html += '<tr>';
                    html += `<td>${txn.transaction_id || txn.TRANSACTION_ID || '-'}</td>`;
                    html += `<td>${txn.transaction_type || txn.TRANSACTION_TYPE || '-'}</td>`;
                    html += `<td>${txn.from_account_number || txn.FROM_ACCOUNT_NUMBER || '-'}</td>`;
                    html += `<td>${txn.to_account_number || txn.TO_ACCOUNT_NUMBER || '-'}</td>`;
                    html += `<td>${formatCurrency(txn.amount || txn.AMOUNT || 0)}</td>`;
                    html += `<td>${txn.status || txn.STATUS || '-'}</td>`;
                    html += `<td>${txn.transaction_date || txn.TRANSACTION_DATE || '-'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                document.getElementById('recentTransactions').innerHTML = html;
            } catch (error) {
                console.error('Error loading recent transactions:', error);
            }
        }
        
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                
                const select = document.getElementById('userSelect');
                select.innerHTML = '<option value="">Select User</option>';
                data.forEach(user => {
                    const option = document.createElement('option');
                    // API returns lowercase field names
                    const userId = user.user_id;
                    const username = user.username;
                    const fullName = user.full_name || '';
                    option.value = userId;
                    option.textContent = `${username} - ${fullName}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        async function loadAccounts() {
            try {
                const response = await fetch('/api/accounts');
                const data = await response.json();
                
                const fromSelect = document.getElementById('fromAccountSelect');
                const toSelect = document.getElementById('toAccountSelect');
                
                [fromSelect, toSelect].forEach(select => {
                    // Keep the first empty option, then add accounts
                    const firstOption = select.querySelector('option[value=""]');
                    if (!firstOption) {
                        select.innerHTML = '<option value="">-- Select Account --</option>';
                    } else {
                        // Remove existing account options but keep the placeholder
                        while (select.children.length > 1) {
                            select.removeChild(select.lastChild);
                        }
                    }
                    data.forEach(account => {
                        const option = document.createElement('option');
                        // API now returns lowercase field names for consistency
                        const accountId = account.account_id;
                        const accountNumber = account.account_number;
                        const balance = account.balance || 0;
                        option.value = accountId;
                        option.textContent = `${accountNumber} (${formatCurrency(balance)})`;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }
        
        async function insertUser(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/api/insert/user', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('User inserted successfully!', 'success');
                    event.target.reset();
                    loadUsers();
                    refreshDashboard();
                } else {
                    showMessage(result.error || 'Error inserting user', 'error');
                }
            } catch (error) {
                showMessage('Error inserting user: ' + error.message, 'error');
            }
        }
        
        async function insertAccount(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            data.balance = parseFloat(data.balance);
            
            try {
                const response = await fetch('/api/insert/account', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Account inserted successfully!', 'success');
                    event.target.reset();
                    loadAccounts();
                    refreshDashboard();
                } else {
                    showMessage(result.error || 'Error inserting account', 'error');
                }
            } catch (error) {
                showMessage('Error inserting account: ' + error.message, 'error');
            }
        }
        
        async function insertTransaction(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            // Clean up based on transaction type and handle empty values
            if (data.transaction_type === 'DEPOSIT') {
                data.from_account_id = null;
                // For deposit, to_account_id is required
                if (!data.to_account_id || data.to_account_id === '') {
                    showMessage('Please select a destination account for deposit', 'error');
                    return;
                }
            } else if (data.transaction_type === 'WITHDRAWAL') {
                data.to_account_id = null;
                // For withdrawal, from_account_id is required
                if (!data.from_account_id || data.from_account_id === '') {
                    showMessage('Please select a source account for withdrawal', 'error');
                    return;
                }
            } else if (data.transaction_type === 'TRANSFER') {
                // For transfer, both accounts are required
                if (!data.from_account_id || data.from_account_id === '') {
                    showMessage('Please select a source account for transfer', 'error');
                    return;
                }
                if (!data.to_account_id || data.to_account_id === '') {
                    showMessage('Please select a destination account for transfer', 'error');
                    return;
                }
            }
            
            // Convert empty strings to null for proper handling
            if (data.from_account_id === '' || data.from_account_id === undefined) {
                data.from_account_id = null;
            } else {
                data.from_account_id = parseInt(data.from_account_id);
            }
            
            if (data.to_account_id === '' || data.to_account_id === undefined) {
                data.to_account_id = null;
            } else {
                data.to_account_id = parseInt(data.to_account_id);
            }
            
            data.amount = parseFloat(data.amount);
            
            // Debug log
            console.log('Transaction data being sent:', data);
            
            try {
                const response = await fetch('/api/insert/transaction', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Transaction executed successfully!', 'success');
                    event.target.reset();
                    updateTransactionForm();
                    refreshDashboard();
                } else {
                    showMessage(result.error || 'Error executing transaction', 'error');
                }
            } catch (error) {
                showMessage('Error executing transaction: ' + error.message, 'error');
            }
        }
        
        function updateTransactionForm() {
            const type = document.getElementById('txnType').value;
            const fromGroup = document.getElementById('fromAccountGroup');
            const toGroup = document.getElementById('toAccountGroup');
            
            if (type === 'DEPOSIT') {
                fromGroup.style.display = 'none';
                toGroup.style.display = 'block';
                document.getElementById('fromAccountSelect').required = false;
                document.getElementById('toAccountSelect').required = true;
            } else if (type === 'WITHDRAWAL') {
                fromGroup.style.display = 'block';
                toGroup.style.display = 'none';
                document.getElementById('fromAccountSelect').required = true;
                document.getElementById('toAccountSelect').required = false;
            } else {
                fromGroup.style.display = 'block';
                toGroup.style.display = 'block';
                document.getElementById('fromAccountSelect').required = true;
                document.getElementById('toAccountSelect').required = true;
            }
        }
        
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        function showMessage(message, type) {
            const messageDiv = document.getElementById('formMessage');
            messageDiv.className = type === 'success' ? 'success-message' : 'error';
            messageDiv.textContent = message;
            
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 5000);
        }
        
        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount || 0);
        }
    </script>
</body>
</html>

